rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role.lower() == 'admin';
    }
    // Helper para verificar se o usuário é gerente de uma gráfica
    function isShopManager(email) {
      return isAuthenticated() && request.auth.token.email.lower() == email.lower();
    }


    // Coleção de Usuários
    match /users/{userId} {
      allow read: if isAuthenticated();
      
      // Dono pode tudo; Outros podem ler e apenas o sistema/admin poderia editar stats (aqui permitimos por simplificação)
      allow create, delete: if isOwner(userId);
      allow update: if isOwner(userId) || (
        isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stats'])
      );

      // Sub-coleção: Lembretes
      match /reminders/{reminderId} {
        allow read, write: if isOwner(userId);
      }

      // Sub-coleção: Certificados
      match /certificates/{certId} {
        allow read: if isAuthenticated();
        // Allow creating/writing if you are the issuer (creator of event usually)
        // Simplified to authenticated for now to unblock feature
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin(); 
      }

      // Sub-coleção: Bookmarks (Salvos)
      match /bookmarks/{bookmarkId} {
        allow read, write: if isOwner(userId);
      }

      // Sub-coleção: Saved Badges (Emblemas Salvos)
      match /savedBadges/{badgeId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Coleção de Conexões (Raiz)
    match /connections/{connId} {
      allow read: if isAuthenticated() && (request.auth.uid in resource.data.users);
      allow create: if isAuthenticated() && (request.auth.uid in request.resource.data.users);
      allow update, delete: if isAuthenticated() && (request.auth.uid in resource.data.users);
    }

    // Coleção de Notificações (Raiz)
    match /notifications/{notifId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated(); // Outro user pode notificar
      allow update, delete: if isAuthenticated() && (resource.data.userId == request.auth.uid);
    }

    // Coleção de Usernames (Para garantir unicidade)
    match /usernames/{username} {
      allow get: if true; // Permitir verificar disponibilidade (get específico)
      allow list: if isAuthenticated();
      allow create: if isAuthenticated(); 
    }

    // Coleção de Emails (Para verificação de disponibilidade pública sem expor dados)
    match /emails/{email} {
      allow get: if true; // Permitir verificar se o email já está cadastrado
      allow create: if isAuthenticated(); // Reservado no cadastro
    }

    // Coleção de Telefones (Para verificação de disponibilidade pública)
    match /phones/{phone} {
      allow get: if true;
      allow create: if isAuthenticated();
    }
    
    // Coleção de Posts
    match /posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.author.id == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.author.id == request.auth.uid || 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likedBy', 'repostedBy'])
      );
      allow delete: if isAuthenticated() && resource.data.author.id == request.auth.uid;
    }

    // Coleção de Badges (Emblemas)
    match /badges/{badgeId} {
      allow read: if isAuthenticated();
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.creatorId == request.auth.uid || 
        // Permite atualizar apenas campos x e y para o dono (para drag & drop)
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['x', 'y']) && resource.data.creatorId == request.auth.uid)
      );
      allow delete: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
    }

    // Coleção de Estações de Impressora
    match /printerStations/{stationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || (isAuthenticated() && isShopManager(resource.data.ownerEmail)); 
    }

    // Coleção de Pedidos de Impressão (Optimized Sync)
    match /printRequests/{orderId} {
      // Admin tem acesso total a TUDO (verificado primeiro, antes de resource.data)
      allow read, write: if isAdmin();
      
      // Leitura permitida para o dono do pedido ou o dono da gráfica (via email no token)
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid || 
        request.auth.token.email.lower() == resource.data.stationOwnerEmail.lower()
      );
      
      allow create: if isAuthenticated() && request.resource.data.customerId == request.auth.uid;
      
      // Atualização (ex: mudar status) permitida para quem tem acesso de leitura
      allow update: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid || 
        request.auth.token.email.lower() == resource.data.stationOwnerEmail.lower()
      );
      
      allow delete: if isAuthenticated() && resource.data.customerId == request.auth.uid;

      // Sub-coleção: Mensagens do Chat
      match /messages/{messageId} {
        // Função helper para verificar acesso ao pedido pai
        function canAccessParentOrder() {
          let parentOrder = get(/databases/$(database)/documents/printRequests/$(orderId));
          return parentOrder.data.customerId == request.auth.uid || 
                 request.auth.token.email.lower() == parentOrder.data.stationOwnerEmail.lower() ||
                 isAdmin();
        }
        
        // Permitir leitura se o usuário tem acesso ao pedido pai
        allow read: if isAuthenticated() && canAccessParentOrder();
        
        // Permitir criação se o usuário tem acesso ao pedido pai e é o remetente
        allow create: if isAuthenticated() && 
          canAccessParentOrder() &&
          request.resource.data.senderId == request.auth.uid;
        
        // Atualização permitida apenas para marcar como lida
        allow update: if isAuthenticated() && 
          canAccessParentOrder() &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      }
    }

    // Coleção de Chats (Mensagens)
    match /chats/{chatId} {
      allow read: if isAuthenticated(); // Temporariamente permissivo para corrigir erro
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid in resource.data.members);

      match /messages/{messageId} {
        allow read, create: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;
      }
    }

    // Coleção de Eventos
    match /events/{eventId} {
      allow read, write: if request.auth != null;
    }

    // Regra Global de Lembretes (caso o service salve na raiz)
    match /reminders/{reminderId} {
      allow read, write: if isAuthenticated();
    }
  }
}
